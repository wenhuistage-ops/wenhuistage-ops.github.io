<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ–‡è¼æ‰“å¡ç³»çµ±</title>
  <style>
    body {
      font-family: ui-sans-serif, system-ui;
      margin: 0;
      background: #f0f2f5;
      display: flex;
      justify-content: center;
      align-items: center;
      align-items: center;
      min-height: 100vh;
      font-size: 16px;
    }
    .container {
      width: 100%;
      max-width: 400px;
      margin: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      background: #fff;
      padding: 24px;
      box-sizing: border-box;
    }
    h1 { font-size: clamp(18px, 4vw, 30px); margin: 0 0 16px; }
    .muted { color:#666; font-size: 14px; margin: 8px 0 16px; }
    button {
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 10px;
      border:0;
      cursor:pointer;
      font-size:16px;
      width: 100%;
    }
    .primary {
      background: linear-gradient(90deg, #4f46e5, #2563eb);
      color:#fff;
    }
    .ghost {
      background:#eef2ff;
      color:#374151;
      border: 1px solid #dbeafe;
    }
      .warning {
        background: #ef4444; /* ç´…è‰² */
        color: #fff;
        border: 1px solid #fca5a5;
      }
    .row { display:flex; flex-direction: column; gap:12px; }
    .msg { margin-top: 16px; padding:12px; border-radius:12px; background:#f1f5f9; }
    .error { background:#fee2e2; color:#991b1b; }
    .ok    { background:#dcfce7; color:#065f46; }
    .foot { margin-top: 20px; font-size: 12px; color:#777; text-align:center;}
    @media (max-width: 480px) {
      .container { margin: 12px; padding: 16px; }
    }
  </style>
</head>
<div class="cardsContainer" style="display:flex; flex-direction:column; gap:8px; align-items:center;">
<body>
  <div class="container" id="normalPunchCard">
      <h1 id="appTitle"></h1>
    <!-- ç™»å…¥ç‹€æ…‹ -->
    <div id="status" class="muted" style="display:flex; align-items:center; gap:8px;">
      <img id="profileImg" src="" alt="é ­åƒ" style="display:none; width:40px; height:40px; border-radius:50%;">
          <span id="userName"></span>
    </div>
    <!-- æ‰“å¡åŠŸèƒ½ -->
    <div id="actions" class="row" style="display:none;">
      <button class="primary" id="btnIn">ä¸Šç­æ‰“å¡</button>
      <button class="ghost" id="btnOut">ä¸‹ç­æ‰“å¡</button>
      <button id="btnLogout" style="margin-left:auto;">ç™»å‡º</button>
    </div>

    <!-- ç™»å…¥å€å¡Š -->
    <div id="login" style="display:none;">
      <button class="primary" id="btnLogin">ä½¿ç”¨ LINE ç™»å…¥</button>
    </div>
    <!-- åŠ è¼‰ä¸­çš„åœ–ç¤º -->
    <div id="loading" style="display:none; text-align:center; margin:10px;">
      <span>â³ è™•ç†ä¸­...</span>
    </div>
    <!-- è¨Šæ¯é¡¯ç¤º -->
    <div id="message" class="msg" style="display:none;"></div>
    <div class="foot" id="footerNotice"></div>
  </div>
  
  <!-- æ–°å¢è£œæ‰“å¡å¡ç‰‡ -->
  <div class="container" id="adjustPunchCard" style="display:none;">
      <!-- æŸ¥çœ‹ç•°å¸¸ç´€éŒ„æŒ‰éˆ•ï¼ˆé è¨­éš±è—ï¼‰ -->
    <button class="warning" id="btnViewAbnormal" style="display:block;">âš ï¸ æŸ¥çœ‹ç•°å¸¸ç´€éŒ„ ğŸ‘€</button>
    <div id="loadingMsg" style="display:none; text-align:center; margin:10px;">
      <span>â³ è™•ç†ä¸­...</span>
    </div>
    <div id="adjustMessage" class="msg" style="display:none;"></div>
    <h1 id="adjustPunchTitle"></h1>
    <div class="row">
      <label id="adjustPunchDateTimeLabel">
          <input id="adjustDateTime" type="datetime-local" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ddd;">
      </label>
      <button class="ghost" id="btnAdjustIn">è£œä¸Šç­æ‰“å¡</button>
      <button class="ghost" id="btnAdjustOut">è£œä¸‹ç­æ‰“å¡</button>
    </div>
   
  </div>
</div>
<script>
    
    let currentLang = localStorage.getItem("lang");
    console.log("ç¾åœ¨èªè¨€:", currentLang);
    if (true) {
      // å–ç€è¦½å™¨èªè¨€ï¼Œä¾‹å¦‚ zh-TW, en-US
      const browserLang = navigator.language || navigator.userLanguage;
      console.log("ç€è¦½å™¨èªè¨€:", browserLang);
      // ç°¡å–®è™•ç†ï¼šåªå–å‰å…©ç¢¼ (zh, en, ja...)
      if (browserLang.startsWith("zh")) {
          console.log("ç€è¦½å™¨èªè¨€:", currentLang);
        currentLang = "zh-TW";
      } else if (browserLang.startsWith("ja")) {
        currentLang = "ja-JP";
      }
      else if (browserLang.startsWith("vi")) {
        currentLang = "vi";
      }
      else {
        currentLang = "en-US"; // é è¨­è‹±æ–‡
      }

      // è¨˜éŒ„ä¸‹ä¾†ï¼Œä¹‹å¾Œå°±ç”¨ localStorage å„ªå…ˆ
      localStorage.setItem("lang", currentLang);
    }
    
    let translations = {};
    console.log("åˆå§‹èªè¨€:", currentLang);

    // è¼‰å…¥èªç³»æª”
    async function loadTranslations(lang) {
      console.log("é–‹å§‹è¼‰å…¥èªç³»:", lang);
      try {
        const res = await fetch(`/i18n/${lang}.json`);
        if (!res.ok) {
          throw new Error(`HTTP éŒ¯èª¤: ${res.status}`);
        }
        translations = await res.json();
        currentLang = lang;
        localStorage.setItem("lang", lang);
        console.log("èªç³»è¼‰å…¥æˆåŠŸ:", translations);
      } catch (err) {
        console.error("è¼‰å…¥èªç³»å¤±æ•—:", err);
      }
    }

    // ç¿»è­¯å‡½å¼

    function t(code, params = {}) {
      let text = translations[code] || code;
      console.log(`ç¿»è­¯æŸ¥è©¢: code='${code}' â†’ '${text}'`);
      for (const key in params) {
          console.log(`åƒæ•¸: params='${params}'`);
        text = text.replace(`{${key}}`, params[key]);
      }
      return text;
    }
    
const API_URL = "https://script.google.com/macros/s/AKfycby28KblKy-ICEGstB7L-UK5rQ1awPokRiIIdqpJ49_7nVmS_oHYiA9qapWtOVo_UnEHbQ/exec";

/* ===== å…±ç”¨è¨Šæ¯é¡¯ç¤º ===== */
function showMessage(text, type="ok", msgId="message") {
  const el = document.getElementById(msgId);
  if (!text) {
    el.textContent = "";
    el.style.display = "none";
    return;
  }
  el.textContent = text;
  el.className = "msg " + type;
  el.style.display = "block";
}

/* ===== JSONP å‘¼å« ===== */
function callApi(action, cb, loadingId="loading") {
  const token = localStorage.getItem("sessionToken");
  const url = `${API_URL}?action=${action}&token=${token}&callback=handleResponse`;
  //window.handleResponse = cb;
  
    // é¡¯ç¤ºæŒ‡å®š loading
    document.getElementById(loadingId).style.display = "block";
    
    window.handleResponse = (res) => {
        // çµ±ä¸€ç¿»è­¯
        console.log("API å›å‚³ï¼š", res);
           res.msg = t(res.code);
       // é—œé–‰ loading
       document.getElementById(loadingId).style.display = "none";
       cb(res);
       // æ¸…ç† scriptï¼Œé¿å…ç´¯ç©
           if (script.parentNode) {
             script.parentNode.removeChild(script);
           }
     };
    
  const script = document.createElement("script");
  script.src = url;
  script.onerror = () => showMessage("é€£ç·šå¤±æ•—","error");
  document.body.appendChild(script);
}

/* ===== äº¤æ›ä¸€æ¬¡æ€§ token ===== */
function exchangeToken(action, otoken, cb) {
  const url = `${API_URL}?action=${action}&otoken=${otoken}&callback=handleExchange`;
  window.handleExchange = cb;
  const script = document.createElement("script");
  script.src = url;
  script.onerror = () => showMessage("é€£ç·šå¤±æ•—","error");
  document.body.appendChild(script);
}
/* ===== è£œæ‰“å¡ ===== */
function callApiAdjustPunch(type, datetime, cb) {
    const token = localStorage.getItem("sessionToken");
    const dateObj = new Date(datetime);
    const lat = 0; // è£œæ‰“å¡ä¸æª¢æŸ¥ GPS
    const lng = 0;

    const url = `${API_URL}?action=adjustPunch&token=${token}&type=${encodeURIComponent(type)}&lat=${lat}&lng=${lng}&datetime=${dateObj.toISOString()}&callback=handleAdjustResponse&note=${encodeURIComponent(navigator.userAgent)}`;
    document.getElementById("loadingMsg").style.display = "block";
    
    window.handleAdjustResponse = (res) => {
       // é—œé–‰ loading
       document.getElementById("loadingMsg").style.display = "none";
       cb(res);
     };

    const script = document.createElement("script");
    script.src = url;
    script.onerror = () => showMessage("é€£ç·šå¤±æ•—", "error", "adjustMessage");
    document.body.appendChild(script);
}
    function ensureLogin() {
      return new Promise((resolve) => {
        callApi("checkSession", (res) => {
          if (res.ok) {
            const Msg = t(res.code,res.params || "UNKNOWN_ERROR");
            document.getElementById("userName").textContent = Msg;
            localStorage.setItem("sessionUserId", res.user.userId);
            let img = document.getElementById("profileImg");
            img.src = res.user.picture || res.user.rate;
            img.style.display = "inline-block";
            document.getElementById("actions").style.display = "block";

            // æª¢æŸ¥ç•°å¸¸æ‰“å¡
            checkAbnormal();
            resolve(true);

          } else {
            // âœ… ä½¿ç”¨ä»£ç¢¼ç¿»è­¯
            const errorMsg = t(res.code || "UNKNOWN_ERROR");

            if (res.code === "ACCOUNT_NOT_ENABLED") {
              document.getElementById("status").textContent = errorMsg;
              showMessage("âŒ " + errorMsg, "error");
            } else {
              document.getElementById("status").textContent = t("PLEASE_RELOGIN");
              document.getElementById("login").style.display = "block";
              document.getElementById("btnLogin").textContent = t("BTN_RELOGIN");
              showMessage("âŒ " + errorMsg, "error");
            }
            resolve(false);
          }
        });
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("adjustDateTime");
      const now = new Date();

      const toLocal = (d) => {
        const pad = (n) => n.toString().padStart(2,'0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      };

      // max = ä»Šå¤©
      input.max = toLocal(now);

      // min = å‰ä¸€å€‹æœˆç¬¬ä¸€å¤© 00:00
      const monthStart = new Date(now.getFullYear(), now.getMonth()-1, 1, 0, 0);
      input.min = toLocal(monthStart);

      // å¯é¸ï¼šå¦‚æœ input é è¨­å€¼è¶…å‡ºç¯„åœï¼Œè‡ªå‹•è¨­ç‚º max
      if (new Date(input.value) > now || !input.value) {
        input.value = toLocal(now);
      }
    });
/* ===== ç™»å…¥æµç¨‹ ===== */
window.addEventListener('DOMContentLoaded', async () => {
    console.log("åˆå§‹åŒ–èªç³»â€¦");
    await loadTranslations(currentLang); // å…ˆè¼‰å…¥èªç³»
    
    // è‡ªå‹•æ›¿æ›æ–‡å­—
    document.getElementById("appTitle").textContent = t("APP_TITLE");
    document.getElementById("userName").textContent = t("CHECKING_LOGIN");
    document.getElementById("footerNotice").textContent = t("FOOTER_NOTICE");
    
    
    document.getElementById("adjustPunchTitle").textContent = t("ADJUST_PUNCH_TITLE");
    document.getElementById("adjustPunchDateTimeLabel").textContent = t("ADJUST_PUNCH_DATETIME_LABEL");
    // åˆå§‹åŒ–æŒ‰éˆ•æ–‡å­—
    document.getElementById("btnLogin").textContent = t("BTN_RELOGIN");
    document.getElementById("btnIn").textContent = t("BTN_PUNCH_IN");
    document.getElementById("btnOut").textContent = t("BTN_PUNCH_OUT");
    document.getElementById("btnLogout").textContent = t("BTN_LOGOUT");
    document.getElementById("btnAdjustIn").textContent = t("BTN_ADJUST_IN");
    document.getElementById("btnAdjustOut").textContent = t("BTN_ADJUST_OUT");
    document.getElementById("btnViewAbnormal").textContent = t("BTN_VIEW_ABNORMAL");
    document.getElementById("loading").textContent = t("LOADING");
    document.getElementById("loadingMsg").textContent = t("LOADING");
    
  const params = new URLSearchParams(window.top.location.search);
  const otoken = params.get('code');

  if (otoken) {
    // å‰›ç™»å…¥å®Œï¼Œäº¤æ› token
    exchangeToken("getProfile", otoken, (res) => {
      if (res.ok && res.sToken) {
        localStorage.setItem("sessionToken", res.sToken);
        
        
        showMessage(t("LOGIN_SUCCESS"));

        ensureLogin();
      } else {
        showMessage(t("ERROR_LOGIN_FAILED", {msg: res.msg || t("UNKNOWN_ERROR")}), "error");

        const container = document.getElementById("login");
        container.style.display = "block";
        container.innerHTML = ""; // æ¸…ç©ºåŸæœ¬å…§å®¹

        const btn = document.createElement("button");
        btn.id = "btnRelogin";
        btn.textContent = t("BTN_RELOGIN");
        btn.className = "primary";
        btn.onclick = () => { window.location.href = "https://wenhuistage-ops.github.io/"; };

        container.appendChild(btn);
      }
    });
  } else {
    // æ²’æœ‰ otoken â†’ æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    ensureLogin();
  }

  /* ===== ç¶å®šæŒ‰éˆ• ===== */
  document.getElementById("btnLogin").onclick = () => {
    callApi("getLoginUrl", (res) => {
      if (res.url) window.location.href = res.url;
    });
  };

  document.getElementById("btnLogout").onclick = () => {
    localStorage.removeItem("sessionToken");
    //location.reload();
    window.location.href = "/index.html"
  };

  function doPunch(type, cb) {
    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const action = `punch&type=${encodeURIComponent(type)}&lat=${lat}&lng=${lng}&note=${encodeURIComponent(navigator.userAgent)}`;
      callApi(action, (res) => { if (cb) cb(res, lat, lng); });
    }, (err) => {
      showMessage(t("ERROR_GEOLOCATION", {msg: err.message}), "error");
    });
  }



  document.getElementById("btnIn").onclick = () => {
    showMessage("");
    doPunch("ä¸Šç­", (res, lat, lng) => {
        // å–å¾—è¨Šæ¯æ–‡å­—ï¼Œè‹¥ res.code æˆ– translations ç¼ºå¤±ï¼Œçµ¦é è¨­è¨Šæ¯
        const msg = t(res.code || "UNKNOWN_ERROR", res.params || {});

        // é¡¯ç¤ºè¨Šæ¯ï¼Œæ ¹æ“š ok ç‹€æ…‹æ±ºå®šæ¨£å¼
        showMessage(msg, res.ok ? "ok" : "error");
    });
  };

  document.getElementById("btnOut").onclick = () => {
    showMessage(""); // å…ˆæ¸…ç©ºè¨Šæ¯

    doPunch("ä¸‹ç­", (res, lat, lng) => {
      // å–å¾—è¨Šæ¯æ–‡å­—ï¼Œè‹¥ res.code æˆ– translations ç¼ºå¤±ï¼Œçµ¦é è¨­è¨Šæ¯
      const msg = t(res.code || "UNKNOWN_ERROR", res.params || {});

      // é¡¯ç¤ºè¨Šæ¯ï¼Œæ ¹æ“š ok ç‹€æ…‹æ±ºå®šæ¨£å¼
      showMessage(msg, res.ok ? "ok" : "error");
    });
  };
});
    function validateAdjustTime() {
      const input = document.getElementById("adjustDateTime");
      const value = input.value;
      if (!value) return false;

      const selected = new Date(value);
      const now = new Date();
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

      if (selected < monthStart) {
        alert("âš ï¸ ä¸èƒ½é¸æ“‡æœ¬æœˆä»¥å‰çš„æ™‚é–“");
        return false;
      }
      if (selected > now) {
        alert("âš ï¸ ä¸èƒ½é¸æ“‡æœªä¾†çš„æ™‚é–“");
        return false;
      }
      return true;
    }
    // ç¶å®šè£œæ‰“å¡æŒ‰éˆ•
    document.getElementById("btnAdjustIn").onclick = () => {
        if (!validateAdjustTime()) return;
      const datetime = document.getElementById("adjustDateTime").value;
      if (!datetime) return showMessage("è«‹é¸æ“‡è£œæ‰“å¡æ—¥æœŸæ™‚é–“", "error", "adjustMessage");
      showMessage("", "ok", "adjustMessage");
      callApiAdjustPunch("ä¸Šç­", datetime, (res) => {
          // å–å¾—è¨Šæ¯æ–‡å­—ï¼Œè‹¥ res.code æˆ– translations ç¼ºå¤±ï¼Œçµ¦é è¨­è¨Šæ¯
          const msg = t(res.code || "UNKNOWN_ERROR", res.params || {});

          // é¡¯ç¤ºè¨Šæ¯ï¼Œæ ¹æ“š ok ç‹€æ…‹æ±ºå®šæ¨£å¼
          showMessage(msg, res.ok ? "ok" : "error","adjustMessage");
      });
    };

    document.getElementById("btnAdjustOut").onclick = () => {
        if (!validateAdjustTime()) return;
      const datetime = document.getElementById("adjustDateTime").value;
      if (!datetime) return showMessage("è«‹é¸æ“‡è£œæ‰“å¡æ—¥æœŸæ™‚é–“", "error", "adjustMessage");
      showMessage("", "ok", "adjustMessage");
      callApiAdjustPunch("ä¸‹ç­", datetime, (res) => {
          // å–å¾—è¨Šæ¯æ–‡å­—ï¼Œè‹¥ res.code æˆ– translations ç¼ºå¤±ï¼Œçµ¦é è¨­è¨Šæ¯
          const msg = t(res.code || "UNKNOWN_ERROR", res.params || {});

          // é¡¯ç¤ºè¨Šæ¯ï¼Œæ ¹æ“š ok ç‹€æ…‹æ±ºå®šæ¨£å¼
          showMessage(msg, res.ok ? "ok" : "error","adjustMessage");
      });
    };

    //æª¢æŸ¥æœ¬æœˆæ‰“å¡ç•°å¸¸
    function checkAbnormal() {
      const now = new Date();
      const month = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0");
      const userId = localStorage.getItem("sessionUserId");

      document.getElementById("loadingMsg").style.display = "block";
      callApi(`getAbnormalRecords&month=${month}&userId=${userId}`, (res) => {
        if (res.ok) {
          const hasAbnormal = res.records.some(r => r.abnormal);
          const btn = document.getElementById("btnViewAbnormal");
          const di = document.getElementById("adjustPunchCard");
          
          if (hasAbnormal) {
            di.style.display = "block";
            btn.onclick = () => {
              window.location.href = `punchCalendar.html?type=abnormal&month=${month}&userId=${userId}`;
            };
          } else {
            btn.style.display = "none";
          }
        }
      }, "loadingMsg");
    }

</script>
</body>
</html>
