<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>文輝打卡系統</title>
  <style>
    body {
      font-family: ui-sans-serif, system-ui;
      margin: 0;
      background: #f0f2f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-size: 16px;
    }
    .container {
      width: 100%;
      max-width: 400px;
      margin: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      background: #fff;
      padding: 24px;
      box-sizing: border-box;
    }
    h1 { font-size: clamp(18px, 4vw, 30px); margin: 0 0 16px; }
    .muted { color:#666; font-size: 14px; margin: 8px 0 16px; }
    button {
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 10px;
      border:0;
      cursor:pointer;
      font-size:16px;
      width: 100%;
    }
    .primary {
      background: linear-gradient(90deg, #4f46e5, #2563eb);
      color:#fff;
    }
    .ghost {
      background:#eef2ff;
      color:#374151;
      border: 1px solid #dbeafe;
    }
    .row { display:flex; flex-direction: column; gap:12px; }
    .msg { margin-top: 16px; padding:12px; border-radius:12px; background:#f1f5f9; }
    .error { background:#fee2e2; color:#991b1b; }
    .ok    { background:#dcfce7; color:#065f46; }
    .foot { margin-top: 20px; font-size: 12px; color:#777; text-align:center;}
    @media (max-width: 480px) {
      .container { margin: 12px; padding: 16px; }
    }
  </style>
</head>
<div class="cardsContainer" style="display:flex; flex-direction:column; gap:8px; align-items:center;">
<body>
  <div class="container" id="normalPunchCard">
    <h1>文輝打卡系統</h1>

    <!-- 登入狀態 -->
    <div id="status" class="muted" style="display:flex; align-items:center; gap:8px;">
      <img id="profileImg" src="" alt="頭像" style="display:none; width:40px; height:40px; border-radius:50%;">
      <span id="userName">正在檢查登入狀態…</span>
    </div>

    <!-- 打卡功能 -->
    <div id="actions" class="row" style="display:none;">
      <button class="primary" id="btnIn">上班打卡</button>
      <button class="ghost" id="btnOut">下班打卡</button>
      <button id="btnLogout" style="margin-left:auto;">登出</button>
    </div>

    <!-- 登入區塊 -->
    <div id="login" style="display:none;">
      <button class="primary" id="btnLogin">使用 LINE 登入</button>
    </div>
    <!-- 加載中的圖示 -->
    <div id="loading" style="display:none; text-align:center; margin:10px;">
      <span>⏳ 處理中...</span>
    </div>
    <!-- 訊息顯示 -->
    <div id="message" class="msg" style="display:none;"></div>
    <div class="foot">※ 登入狀態保存在你的瀏覽器（localStorage）。若換裝置或清除資料需重新登入。</div>
  </div>
  
  <!-- 新增補打卡卡片 -->
  <div class="container" id="adjustPunchCard" style="display:none;">
      <!-- 查看異常紀錄按鈕（預設隱藏） -->
    <button id="btnViewAbnormal" style="display:none;">查看異常紀錄</button>
    <h1>補打卡</h1>
    <div class="row">
      <label>補打卡日期與時間：
        <input type="datetime-local" id="adjustDateTime" />
      </label>
      <button class="ghost" id="btnAdjustIn">補上班打卡</button>
      <button class="ghost" id="btnAdjustOut">補下班打卡</button>
    </div>
    <div id="adjustMessage" class="msg" style="display:none;"></div>
   
  </div>
</div>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycby28KblKy-ICEGstB7L-UK5rQ1awPokRiIIdqpJ49_7nVmS_oHYiA9qapWtOVo_UnEHbQ/exec";

/* ===== 共用訊息顯示 ===== */
function showMessage(text, type="ok", msgId="message") {
  const el = document.getElementById(msgId);
  if (!text) {
    el.textContent = "";
    el.style.display = "none";
    return;
  }
  el.textContent = text;
  el.className = "msg " + type;
  el.style.display = "block";
}

/* ===== JSONP 呼叫 ===== */
function callApi(action, cb) {
  const token = localStorage.getItem("sessionToken");
  const url = `${API_URL}?action=${action}&token=${token}&callback=handleResponse`;
  //window.handleResponse = cb;
  
  // 顯示 loading
    document.getElementById("loading").style.display = "block";
    
    window.handleResponse = (res) => {
       // 關閉 loading
       document.getElementById("loading").style.display = "none";
       cb(res);
     };
    
  const script = document.createElement("script");
  script.src = url;
  script.onerror = () => showMessage("連線失敗","error");
  document.body.appendChild(script);
}

/* ===== 交換一次性 token ===== */
function exchangeToken(action, otoken, cb) {
  const url = `${API_URL}?action=${action}&otoken=${otoken}&callback=handleExchange`;
  window.handleExchange = cb;
  const script = document.createElement("script");
  script.src = url;
  script.onerror = () => showMessage("連線失敗","error");
  document.body.appendChild(script);
}
/* ===== 補打卡 ===== */
function callApiAdjustPunch(type, datetime, cb) {
    const token = localStorage.getItem("sessionToken");
    const dateObj = new Date(datetime);
    const lat = 0; // 補打卡不檢查 GPS
    const lng = 0;

    const url = `${API_URL}?action=adjustPunch&token=${token}&type=${encodeURIComponent(type)}&lat=${lat}&lng=${lng}&datetime=${dateObj.toISOString()}&callback=handleAdjustResponse&note=${encodeURIComponent(navigator.userAgent)}`;
    window.handleAdjustResponse = cb;

    const script = document.createElement("script");
    script.src = url;
    script.onerror = () => showMessage("連線失敗", "error", "adjustMessage");
    document.body.appendChild(script);
}
/* ===== 檢查登入狀態 ===== */
function ensureLogin() {
  return new Promise((resolve) => {
    callApi("checkSession", (res) => {
      if (res.ok) {
        document.getElementById("userName").textContent = "已登入：" + res.user.name;
        let img = document.getElementById("profileImg");
        img.src = res.user.picture || res.user.rate;
        img.style.display = "inline-block";
        document.getElementById("actions").style.display = "block";

        //檢查異常打卡
        checkAbnormal();
        // 顯示補打卡卡片
        document.getElementById("adjustPunchCard").style.display = "block";
        resolve(true);
      } else {
       
        if(res.error=="未啟用！請通知管理員！")
        {
            document.getElementById("status").textContent = "您的帳號未啟用！請通知管理員！";
            showMessage("❌ 檢查失敗：" + (res.error || "未知錯誤"), "error");
        }
        else
        {
            document.getElementById("status").textContent = "請重新登入更新認證";
            document.getElementById("login").style.display = "block";
            document.getElementById("btnLogin").textContent = "重新登入";
            showMessage("❌ 檢查失敗：" + (res.error || "未知錯誤"), "error");
        }
        resolve(false);
      }
    });
  });
}

/* ===== 登入流程 ===== */
window.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.top.location.search);
  const otoken = params.get('code');

  if (otoken) {
    // 剛登入完，交換 token
    exchangeToken("getProfile", otoken, (res) => {
      if (res.ok && res.sToken) {
        localStorage.setItem("sessionToken", res.sToken);
        showMessage("✅ 登入成功，已儲存 Token！");

        ensureLogin();
      } else {
        showMessage("❌ 登入失敗：" + (res.msg || "未知錯誤"), "error");

        const container = document.getElementById("login");
        container.style.display = "block";
        container.innerHTML = ""; // 清空原本內容

        const btn = document.createElement("button");
        btn.id = "btnRelogin";
        btn.textContent = "重新登入";
        btn.className = "primary";
        btn.onclick = () => { window.location.href = "https://wenhuistage-ops.github.io/"; };

        container.appendChild(btn);
      }
    });
  } else {
    // 沒有 otoken → 檢查登入狀態
    ensureLogin();
  }

  /* ===== 綁定按鈕 ===== */
  document.getElementById("btnLogin").onclick = () => {
    callApi("getLoginUrl", (res) => {
      if (res.url) window.location.href = res.url;
    });
  };

  document.getElementById("btnLogout").onclick = () => {
    localStorage.removeItem("sessionToken");
    //location.reload();
    window.location.href = "/index.html"
  };

  function doPunch(type, cb) {
    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const action = `punch&type=${encodeURIComponent(type)}&lat=${lat}&lng=${lng}&note=${encodeURIComponent(navigator.userAgent)}`;
      callApi(action, (res) => { if (cb) cb(res, lat, lng); });
    }, (err) => {
      showMessage("⚠️ 無法取得定位：" + err.message, "error");
    });
  }

  
  document.getElementById("btnIn").onclick = () => {
    showMessage("");
    doPunch("上班", (res, lat, lng) => {
      showMessage(
        res.ok ? `✅ 上班打卡成功 (${lat.toFixed(5)}, ${lng.toFixed(5)})`
               : `❌ 上班打卡失敗：${res.error || ''}`,
        res.ok ? "ok" : "error"
      );
    });
  };

  document.getElementById("btnOut").onclick = () => {
    showMessage("");
    doPunch("下班", (res, lat, lng) => {
      showMessage(
        res.ok ? `✅ 下班打卡成功 (${lat.toFixed(5)}, ${lng.toFixed(5)})`
               : `❌ 下班打卡失敗：${res.error || ''}`,
        res.ok ? "ok" : "error"
      );
    });
  };
});
    
    // 綁定補打卡按鈕
    document.getElementById("btnAdjustIn").onclick = () => {
      const datetime = document.getElementById("adjustDateTime").value;
      if (!datetime) return showMessage("請選擇補打卡日期時間", "error", "adjustMessage");
      showMessage("", "ok", "adjustMessage");
      callApiAdjustPunch("上班", datetime, (res) => {
        showMessage(
          res.ok ? `✅ 上班補打卡成功` : `❌ 上班補打卡失敗：${res.error || ''}`,
          res.ok ? "ok" : "error",
          "adjustMessage"
        );
      });
    };

    document.getElementById("btnAdjustOut").onclick = () => {
      const datetime = document.getElementById("adjustDateTime").value;
      if (!datetime) return showMessage("請選擇補打卡日期時間", "error", "adjustMessage");
      showMessage("", "ok", "adjustMessage");
      callApiAdjustPunch("下班", datetime, (res) => {
        showMessage(
          res.ok ? `✅ 下班補打卡成功` : `❌ 下班補打卡失敗：${res.error || ''}`,
          res.ok ? "ok" : "error",
          "adjustMessage"
        );
      });
    };
    // 綁定按鈕行為-查看異常
    document.getElementById("btnViewAbnormal").onclick = () => {
      window.location.href = "records.html"; // 或者開啟彈窗
    };
    //檢查本月打卡異常
    function checkAbnormal() {
      const now = new Date();
      const month = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0");
      const userId = localStorage.getItem("sessionToken"); // 假設你有存登入者 ID

      callApi(`getAbnormalRecords&month=${month}&userId=${userId}`, (res) => {
        if (res.ok) {
          const hasAbnormal = res.records.some(r => r.abnormal);
          document.getElementById("btnViewAbnormal").style.display = hasAbnormal ? "block" : "none";
        }
      });
    }
</script>
</body>
</html>
