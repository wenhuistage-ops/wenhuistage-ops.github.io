<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>文輝打卡系統</title>
  <style>
    body { font-family: system-ui; margin:0; background:#f7f7f8; padding:20px; }
    .card { max-width:400px; margin:40px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    button { padding:12px; width:100%; border:0; border-radius:8px; font-size:16px; cursor:pointer; }
    .primary { background:#2563eb; color:#fff; }
    .ghost { background:#e5e7eb; }
    .msg { margin-top:16px; padding:12px; border-radius:8px; font-size:14px; }
    .ok { background:#dcfce7; color:#065f46; }
    .error { background:#fee2e2; color:#991b1b; }
  </style>
</head>
<body>
  <div class="card">
    <h1>文輝打卡系統</h1>
    <div id="status">檢查登入中...</div>
    <div id="actions" style="display:none;">
      <button class="primary" id="btnIn">上班打卡</button>
      <button class="ghost" id="btnOut">下班打卡</button>
      <button id="btnLogout">登出</button>
    </div>
    <div id="login" style="display:none;">
      <button class="primary" id="btnLogin">使用 LINE 登入</button>
    </div>
    <div id="message" class="msg" style="display:none;"></div>
  </div>

<script>
    
    
const API_URL = "https://script.google.com/macros/s/AKfycbwx-wMUt5RrIGOe84oJh_1cvfphfOHAb8VqBHCGfOX1gBODy1DYMijHEhsRiw4fdYmnhQ/exec";

// 如果網址帶 token → 存進 localStorage
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.has("token")) {
  localStorage.setItem("sessionToken", urlParams.get("token"));
  // 移除網址上的 token
  window.history.replaceState({}, document.title, location.pathname);
}

function showMessage(text, type="ok") {
  const el = document.getElementById("message");
  el.textContent = text;
  el.className = "msg " + type;
  el.style.display = "block";
}

function callApi(action, cb) {
  const token = localStorage.getItem("sessionToken");
  const url = `${API_URL}?action=${action}&token=${token}&callback=handleResponse`;

  window.handleResponse = cb;

  const script = document.createElement("script");
  script.src = url;
  script.onerror = () => showMessage("連線失敗","error");
  document.body.appendChild(script);
}
  
  // JSONP 交換一次性 token
  function exchangeToken(otoken, cb) {
    const url = `${API_URL}?action=exchangeToken&otoken=${otoken}&callback=handleExchange`;
    window.handleExchange = cb;

    const script = document.createElement("script");
    script.src = url;
    document.body.appendChild(script);
  }
// 檢查登入狀態
function ensureLogin() {
  callApi("checkSession", (res) => {
    if (res.ok) {
      document.getElementById("status").textContent = "已登入：" + res.user;
      document.getElementById("actions").style.display = "block";
    } else {
      document.getElementById("status").textContent = "尚未登入";
      document.getElementById("login").style.display = "block";
    }
  });
}
    
    // DOMContentLoaded
    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const otoken = params.get('otoken');
      
      if (otoken) {
        // 用 JSONP 交換一次性 token
        exchangeToken(otoken, res => {
          if(res.ok) {
            localStorage.setItem('sessionToken', res.sessionToken);
            window.history.replaceState({}, document.title, window.location.pathname);
            ensureLogin();
          } else {
            alert("登入失敗：" + res.error);
          }
        });
      } else {
        ensureLogin();
      }

    
document.getElementById("btnLogin").onclick = () => {
  callApi("getLoginUrl", (res) => {
    if (res.url) window.location.href = res.url;
  });
};

document.getElementById("btnLogout").onclick = () => {
  localStorage.removeItem("sessionToken");
  location.reload();
};

document.getElementById("btnIn").onclick = () => {
  callApi("punchIn", (res) => showMessage(res.msg, res.ok ? "ok":"error"));
};

document.getElementById("btnOut").onclick = () => {
  callApi("punchOut", (res) => showMessage(res.msg, res.ok ? "ok":"error"));
};

// 初始化
ensureLogin();
</script>
</body>
</html>
