<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
      <title>文輝打卡系統</title>
      <style>
        /* 全局樣式 */
        body {
          font-family: ui-sans-serif, system-ui;
          margin: 0;
          background: #f0f2f5;  /* 卡片外圍灰色背景 */
          display: flex;
          justify-content: center;
          align-items: center;
          min-height: 100vh;
          font-size: 16px;
        }

        /* 卡片容器 */
        .container {
          width: 100%;
          max-width: 400px;       /* 卡片寬度限制 */
          margin: 16px;           /* 外圍留空 */
          border-radius: 16px;    /* 圓角 */
          box-shadow: 0 4px 20px rgba(0,0,0,0.1); /* 卡片陰影 */
          background: #fff;
          padding: 24px;
          box-sizing: border-box;
        }

        h1 { font-size: clamp(18px, 4vw, 30px); margin: 0 0 16px; }
        .muted { color:#666; font-size: 14px; margin: 8px 0 16px; }

        button {
          padding: 12px 16px;
          border-radius: 12px;
          margin-bottom: 10px; /* 三個按鈕之間會有 10px 間距 */
          border:0;
          cursor:pointer;
          font-size:16px;
          width: 100%; /* 撐滿手機寬度 */
        }

        .primary {
          background: linear-gradient(90deg, #4f46e5, #2563eb);
          color:#fff;
        }
        .ghost {
          background:#eef2ff;
          color:#374151;
          border: 1px solid #dbeafe;
        }

        .row { display:flex; flex-direction: column; gap:12px; }
       

        .msg { margin-top: 16px; padding:12px; border-radius:12px; background:#f1f5f9; }
        .error { background:#fee2e2; color:#991b1b; }
        .ok    { background:#dcfce7; color:#065f46; }
        .foot { margin-top: 20px; font-size: 12px; color:#777; text-align:center;}

        @media (max-width: 480px) {
          .container {
            margin: 12px;
            padding: 16px;
          }
        }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>文輝打卡系統</h1>
        <div id="status" class="muted" style="display:flex; align-items:center; gap:8px;">
          <img id="profileImg" src="" alt="頭像" style="display:none; width:40px; height:40px; border-radius:50%;">
          <span id="userName">正在檢查登入狀態…</span>
        </div>

        <div id="actions" class="row" style="display:none;">
          <button class="primary" id="btnIn">上班打卡</button>
          <button class="ghost" id="btnOut">下班打卡</button>
          <button id="btnLogout" style="margin-left:auto;">登出</button>
        </div>

        <div id="login" style="display:none;">
          <button class="primary" id="btnLogin">使用 LINE 登入</button>
        </div>

        <div id="message" class="msg" style="display:none;"></div>
        <div class="foot">※ 登入狀態保存在你的瀏覽器（localStorage）。若換裝置或清除資料需重新登入。</div>
      </div>
  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycby28KblKy-ICEGstB7L-UK5rQ1awPokRiIIdqpJ49_7nVmS_oHYiA9qapWtOVo_UnEHbQ/exec";
  
  function showMessage(text, type="ok") {
    const el = document.getElementById("message");
    if (!text) { // 如果沒有傳訊息就清空
      el.textContent = "";
      el.style.display = "none";
      return;
    }
    el.textContent = text;
    el.className = "msg " + type;
    el.style.display = "block";
  }

  // JSONP 呼叫
  function callApi(action, cb) {
    const token = localStorage.getItem("sessionToken");
    const url = `${API_URL}?action=${action}&token=${token}&callback=handleResponse`;

    window.handleResponse = cb;

    const script = document.createElement("script");
    
    script.src = url;
    script.onerror = () => showMessage("連線失敗","error");
    document.body.appendChild(script);

  }

  // JSONP 交換一次性 token
  function exchangeToken(action,otoken, cb) {
    const url = `${API_URL}?action=${action}&otoken=${otoken}&callback=handleExchange`;
    window.handleExchange = cb;
    const script = document.createElement("script");
    script.src = url;
    script.onerror = () => showMessage("連線失敗","error");
    document.body.appendChild(script);
  }

  // 檢查登入狀態
  function ensureLogin() {
    return new Promise((resolve) => {
      callApi("checkSession", (res) => {
        if (res.ok) {
            document.getElementById("userName").textContent = "已登入：" + res.user.name;
            let img = document.getElementById("profileImg");
            img.src = res.user.picture || res.user.rate; // 你回傳的參數有時叫 rate
            img.style.display = "inline-block";
            document.getElementById("actions").style.display = "block";

          resolve(true);
        } else {
          document.getElementById("status").textContent = "尚未登入";
          document.getElementById("login").style.display = "block";
          resolve(false);
        }
        showMessage(
          res.ok ? `✅ 登入成功 (${lat.toFixed(5)}, ${lng.toFixed(5)})`
                 : `❌ 登入失敗：${res.error || ''}`,
          res.ok ? "ok" : "error"
        );
      });
    });
  }

  // DOMContentLoaded
    window.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.top.location.search);
    const otoken = params.get('code');
    
    if (otoken) { // 剛登入完
      exchangeToken("getProfile", otoken, (res) => {
        if (res.ok && res.sToken) {
          // 把 sToken 存進 localStorage
          localStorage.setItem("sessionToken", res.sToken);
          alert("登入成功，已儲存 Token！");
          console.log("已寫入 localStorage：", res.sToken);

          (async () => {
            let loggedIn = await ensureLogin();
            console.log("登入狀態：", loggedIn);
            alert(loggedIn ? "檢查成功 " + loggedIn : "檢查失敗 " + loggedIn);
          })();
          showMessage(res.msg);
        } else {
          alert("登入失敗：" + res.msg);
          showMessage("333333");
          // 取得容器
          
          const container = document.getElementById("login");
          if (container) {
              console.log("重新登入");
            // 正確建立按鈕
            container.innerHTML = '<button id="btnRelogin">重新登入</button>';

            // 立刻取得按鈕並綁定事件
            const btn = document.getElementById("btnRelogin");
            if (btn) {
              btn.onclick = () => {
                window.location.href = "https://wenhuistage-ops.github.io/";
              };
            }
          } else {
              console.log("找不到 #login 容器，無法建立重新登入按鈕");
          }
        }
      });
    }

    else//需要檢查
    {
        (async () => {let loggedIn = await ensureLogin();
          console.log("登入狀態：", loggedIn);
          if(loggedIn)
          {
              alert("檢查成功 " + loggedIn);
          }
          else
          {
              alert("檢查失敗 " + loggedIn);
          }
        })();

    }
    document.getElementById("btnLogin").onclick = () => {
      callApi("getLoginUrl", (res) => {
        if (res.url) window.location.href = res.url;
      });
    };

    document.getElementById("btnLogout").onclick = () => {
      localStorage.removeItem("sessionToken");
      location.reload();
    };

    // 專門給打卡用的包裝函式
    function doPunch(type, cb) {
        console.log("doPunch：");
        navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        // 呼叫 punch API，但把經緯度和 type 放進去
        const action = `punch&type=${encodeURIComponent(type)}&lat=${lat}&lng=${lng}&note=${encodeURIComponent(navigator.userAgent)}`;

        callApi(action, (res) => {
          if (cb) cb(res, lat, lng);
        });

      }, (err) => {
        showMessage("⚠️ 無法取得定位：" + err.message, "error");
      });
    }

    // 綁定按鈕
    document.getElementById("btnIn").onclick = () => {
        showMessage("");  // 清空上次訊息
      doPunch("上班", (res, lat, lng) => {
        showMessage(
          res.ok ? `✅ 上班打卡成功 (${lat.toFixed(5)}, ${lng.toFixed(5)})`
                 : `❌ 上班打卡失敗：${res.error || ''}`,
          res.ok ? "ok" : "error"
        );
      });
    };

    document.getElementById("btnOut").onclick = () => {
        showMessage("");  // 清空上次訊息
      doPunch("下班", (res, lat, lng) => {
        showMessage(
          res.ok ? `✅ 下班打卡成功 (${lat.toFixed(5)}, ${lng.toFixed(5)})`
                 : `❌ 下班打卡失敗：${res.error || ''}`,
          res.ok ? "ok" : "error"
        );
      });
    };
    
  });
  </script>

</body>
</html>
