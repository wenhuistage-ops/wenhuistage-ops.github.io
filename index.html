<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <title>員工打卡系統</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 40px; }
    button { font-size: 18px; padding: 10px 20px; margin: 10px; }
    #status { margin: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>員工打卡系統</h1>
  <div id="status">載入中...</div>
  <div id="buttons" style="display:none;">
    <button onclick="punch('punchIn')">上班打卡</button>
    <button onclick="punch('punchOut')">下班打卡</button>
  </div>
  <button id="loginBtn" style="display:none;" onclick="getLoginUrl()">LINE 登入</button>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwx-wMUt5RrIGOe84oJh_1cvfphfOHAb8VqBHCGfOX1gBODy1DYMijHEhsRiw4fdYmnhQ/exec"; // ⚠️ 請改成部署後的 URL
    let sessionToken = localStorage.getItem("sessionToken") || null;

    // === 主流程 ===
    window.onload = async () => {
      const params = new URLSearchParams(location.search);

      // 如果帶有一次性 otoken，交換成 sessionToken
      if (params.has("otoken")) {
        const otoken = params.get("otoken");
        await exchangeToken(otoken);
        history.replaceState(null, "", location.pathname); // 清除網址上的 otoken
      }

      if (sessionToken) {
        checkSession();
      } else {
        document.getElementById("status").innerText = "尚未登入";
        document.getElementById("loginBtn").style.display = "inline-block";
      }
    };

    // === 向 GAS 要求登入 URL ===
    async function getLoginUrl() {
      const url = `${GAS_URL}?action=getLoginUrl&callback=?`;
      const resp = await fetchJsonp(url).then(r => r.json());
      if (resp.url) {
        location.href = resp.url;
      } else {
        alert("取得登入網址失敗");
      }
    }

    // === 交換一次性 token ===
    async function exchangeToken(otoken) {
      const url = `${GAS_URL}?action=exchangeToken&otoken=${otoken}&callback=?`;
      const resp = await fetchJsonp(url).then(r => r.json());
      if (resp.ok) {
        sessionToken = resp.sessionToken;
        localStorage.setItem("sessionToken", sessionToken);
        document.getElementById("status").innerText = "登入成功";
      } else {
        document.getElementById("status").innerText = "登入失敗: " + resp.error;
      }
    }

    // === 檢查 Session ===
    async function checkSession() {
      const url = `${GAS_URL}?action=checkSession&token=${sessionToken}&callback=?`;
      const resp = await fetchJsonp(url).then(r => r.json());
      if (resp.ok) {
        document.getElementById("status").innerText = `歡迎 ${resp.user.name}`;
        document.getElementById("buttons").style.display = "block";
      } else {
        document.getElementById("status").innerText = "尚未登入: " + resp.error;
        document.getElementById("loginBtn").style.display = "inline-block";
        localStorage.removeItem("sessionToken");
        sessionToken = null;
      }
    }

    // === 打卡 ===
    async function punch(type) {
      const url = `${GAS_URL}?action=${type}&token=${sessionToken}&callback=?`;
      const resp = await fetchJsonp(url).then(r => r.json());
      if (resp.ok) {
        alert(resp.msg);
      } else {
        alert("打卡失敗: " + resp.error);
      }
    }

    // JSONP helper
    function fetchJsonp(url) {
      return new Promise((resolve, reject) => {
        const callbackName = "cb" + Math.random().toString(36).substr(2);
        url = url.replace("callback=?", "callback=" + callbackName);
        const script = document.createElement("script");
        script.src = url;
        script.onerror = reject;
        window[callbackName] = data => {
          resolve({ json: () => Promise.resolve(data) });
          document.body.removeChild(script);
          delete window[callbackName];
        };
        document.body.appendChild(script);
      });
    }
  </script>
</body>
</html>
