<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>文輝打卡系統</title>
<style>
  body { font-family: ui-sans-serif, system-ui; margin:0; background:#f7f7f8; font-size:16px; }
  .container { width:100%; margin:0; padding:16px; background:#fff; box-sizing:border-box; }
  h1 { font-size: clamp(18px,4vw,30px); margin:0 0 16px; }
  .muted { color:#666; font-size:14px; margin:8px 0 16px; }
  button { padding:12px 16px; border-radius:12px; border:0; cursor:pointer; font-size:16px; width:100%; }
  .primary { background:#2563eb; color:#fff; }
  .ghost { background:#eef2ff; color:#374151; }
  .row { display:flex; flex-direction: column; gap:12px; }
  @media (min-width: 480px) { .row { flex-direction: row; } button { flex:1; } }
  .msg { margin-top:16px; padding:12px; border-radius:12px; background:#f1f5f9; }
  .error { background:#fee2e2; color:#991b1b; }
  .ok    { background:#dcfce7; color:#065f46; }
  .foot { margin-top:20px; font-size:12px; color:#777; text-align:center; }
</style>
</head>
<body>
<div class="container">
  <h1>文輝打卡系統</h1>
  <div id="status" class="muted">正在檢查登入狀態…</div>

  <div id="actions" class="row" style="display:none;">
    <button class="primary" id="btnIn">上班打卡</button>
    <button class="ghost" id="btnOut">下班打卡</button>
    <button id="btnLogout" style="margin-left:auto;">登出</button>
  </div>

  <div id="login" style="display:none;">
    <button class="primary" id="btnLogin">使用 LINE 登入</button>
  </div>

  <div id="message" class="msg" style="display:none;"></div>
  <div class="foot">
    ※ 登入狀態保存在你的瀏覽器（localStorage）。若換裝置或清除資料需重新登入。
  </div>
</div>

<script>
// ====== 設定 Web App URL ======
const API_URL = "https://script.google.com/macros/s/AKfycbwshaaU6fiNJA0dnFSacIELj5_7ja-BRDQyahtxCBUOvbgS-MjRiaFzlxtdXR3bYL7o/exec";

// ====== fetch POST 封裝 ======
async function POST(json) {
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(json)
  });
  return res.json();
}

const $ = id => document.getElementById(id);
const setMsg = (text, ok=true) => {
  const el = $("message");
  el.textContent = text;
  el.className = "msg " + (ok ? "ok" : "error");
  el.style.display = "block";
};

async function ensureLoginOrShowButton() {
  $("message").style.display = "none";
  let token = localStorage.getItem("sessionToken");

  if (token) {
    try {
      const res = await POST({ action:"checkSession", sessionToken: token });
      if (res.ok) {
        $("status").textContent = "✅ 已登入";
        $("actions").style.display = "";
        $("login").style.display = "none";
        bindPunch(token);
        return;
      } else {
        throw new Error(res.error || "Session 已失效");
      }
    } catch (err) {
      console.warn("checkSession 失敗:", err);
      localStorage.removeItem("sessionToken");
      $("status").textContent = err;
    }
  }

  // 尚未登入
  $("status").textContent = "尚未登入";
  $("actions").style.display = "none";
  $("login").style.display = "";
  bindLoginButton();
}

function bindLoginButton() {
  $("btnLogin").onclick = async () => {
    const res = await POST({ action: "loginUrl" });
    if (res.ok && res.url) {
      // Google Sites 內 iframe 用 _top 開新頁面避免 sandbox
      window.open(res.url, "_top");
    } else {
      setMsg("無法取得登入網址，請稍後再試", false);
    }
  };
}

function bindPunch(sessionToken) {
  $("btnIn").onclick = () => doPunch(sessionToken, "上班");
  $("btnOut").onclick = () => doPunch(sessionToken, "下班");
  $("btnLogout").onclick = async () => {
    await POST({ action:"logout", sessionToken });
    localStorage.removeItem("sessionToken");
    $("status").textContent = "已登出";
    $("actions").style.display = "none";
    $("login").style.display = "";
    setMsg("你已登出");
    ensureLoginOrShowButton();
  };
}

async function doPunch(sessionToken, type) {
  navigator.geolocation.getCurrentPosition(async pos => {
    const res = await POST({
      action: "punch",
      sessionToken,
      type,
      lat: pos.coords.latitude,
      lng: pos.coords.longitude,
      note: navigator.userAgent
    });
    if (res.ok) setMsg(`✅ ${type} 打卡成功 (${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)})`);
    else setMsg(`❌ ${type} 打卡失敗：${res.error || ""}`, false);
  }, err => {
    setMsg("⚠️ 無法取得定位：" + err.message, false);
  });
}

// 啟動
ensureLoginOrShowButton();
</script>
</body>
</html>
