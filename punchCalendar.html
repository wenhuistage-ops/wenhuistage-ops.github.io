<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="pageTitle"></title>
<style>
body {
  font-family: ui-sans-serif, system-ui;
  background:#f0f2f5;
  margin:0;
  display:flex;
  justify-content:center;
  padding:20px;
}
.container {
  max-width:520px;
  width:100%;
  background:#fff;
  border-radius:16px;
  padding:16px;
  box-shadow:0 4px 20px rgba(0,0,0,0.1);
}
header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
}
button {
  padding:8px 12px;
  border-radius:12px;
  border:0;
  cursor:pointer;
}
button.primary {
  background: linear-gradient(90deg,#4f46e5,#2563eb);
  color:#fff;
}
button.ghost {
  background:#eef2ff;
  color:#374151;
  border:1px solid #dbeafe;
}
.calendar {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
}
.day-card {
  background:#fff;
  border-radius:12px;
  padding:6px;
  min-height:70px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  display:flex;
  flex-direction:column;
  font-size:13px;
  position:relative;
}
.day-card.today { border: 2px solid #2563eb; }
.day-card .date { font-weight:600; margin-bottom:4px; }

.day-card .status {
  font-size: 13px;
  padding:4px 8px;
  border-radius:12px;
  color:#fff;
  text-align:center;
  display:inline-block;
  margin-top:2px;
}
.status.normal { background:#16a34a; }
.status.abnormal { background:#dc2626; }

.day-card .tag-label {
  font-size: 13px;
  padding: 4px 8px;
  border-radius: 12px;
  color: #fff;
  text-align: center;
  display: inline-block;
  margin-right: 4px;
  margin-bottom:2px;
}
.tag-label.虛 { background: #6366f1; } /* 紫色，虛擬卡 */
.tag-label.補 { background: #f97316; } /* 橘色，補打卡 */

.modal-backdrop {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.35);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal {
  background:#fff;
  padding:16px;
  border-radius:12px;
  min-width:280px;
  max-width:90%;
}
</style>
</head>
<body>
<div class="container">
  <header>
    <button id="prevMonth" class="ghost"></button>
    <h2 id="monthLabel"></h2>
    <div style="display:flex; gap:8px;">
      <button id="homePage" class="primary"></button>
      <button id="nextMonth" class="ghost"></button>
    </div>
  </header>
  <div class="calendar" id="calendar"></div>
</div>

<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3 id="modalTitle"></h3>
    <div id="modalBody" style="margin-top:8px; white-space:pre-line; font-size:14px;"></div>
    <div style="text-align:right;margin-top:12px">
      <button id="closeModal" class="ghost"></button>
    </div>
  </div>
</div>

<script src="js/i18n.js"></script>

<script>
(async () => {
  await loadTranslations(); // 載入目前語言的 JSON

  // 修改頁面文字
  document.title = t("calendar_title");
  document.getElementById("pageTitle").textContent = t("calendar_title");
  document.getElementById("prevMonth").textContent = t("prev_month");
  document.getElementById("nextMonth").textContent = t("next_month");
  document.getElementById("homePage").textContent = t("home_page");
  document.getElementById("modalTitle").textContent = t("modal_detail_title");
  document.getElementById("closeModal").textContent = t("close");
})();

const calendarEl = document.getElementById('calendar');
const monthLabel = document.getElementById('monthLabel');
const modalBackdrop = document.getElementById('modalBackdrop');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');

let currentDate = new Date();
let myRecords = [];

function fetchAttendanceDetails(year, month) {
  const userId = localStorage.getItem('sessionUserId');
  const monthStr = `${year}-${String(month).padStart(2,'0')}`;
  const action = `getAttendanceDetails&month=${monthStr}&userId=${userId}`;
  callApi(action, res => {
    if(res.ok){
      myRecords = res.records;
      renderCalendar();
    } else {
      alert(res.msg || t("load_failed"));
    }
  });
}

function renderCalendar(){
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  monthLabel.textContent = `${year} ${t("year")} ${month+1} ${t("month")}`;

  const lastDay = new Date(year, month+1, 0);
  const today = new Date();

  calendarEl.innerHTML = '';

  for(let d=1; d<=lastDay.getDate(); d++){
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const record = myRecords.find(r => r.date === dateStr);

    const card = document.createElement('div');
    card.className = 'day-card';
    if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
      card.classList.add("today");
    }

    const dateEl = document.createElement('div');
    dateEl.className = 'date';
    dateEl.textContent = d;
    card.appendChild(dateEl);

    if(record){
      let abnormal = false;
      const tagsContainer = document.createElement('div');
      tagsContainer.style.display = 'flex';
      tagsContainer.style.gap = '4px';
      tagsContainer.style.flexWrap = 'wrap';

      record.items.forEach(i=>{
        if(i.source === "虛擬卡"){
          const tagEl = document.createElement('div');
          tagEl.className = 'tag-label 虛';
          tagEl.textContent = t("status_virtual");
          tagsContainer.appendChild(tagEl);
        }
        if(i.source === "補打卡" && !i.approved){
          abnormal = true;
          const tagEl = document.createElement('div');
          tagEl.className = 'tag-label 補';
          tagEl.textContent = `${t("status_repair")}(${t("repair_pending")})`;
          tagsContainer.appendChild(tagEl);
        }
      });

      // 判斷是否缺上下班
      const types = record.items.map(i=>i.type);
      if(!types.includes("上班") || !types.includes("下班")){
        abnormal = true;
      }

      if(tagsContainer.childElementCount > 0){
        card.appendChild(tagsContainer);
      }

      // 狀態
      const statusEl = document.createElement('div');
      statusEl.className = 'status ' + (abnormal ? 'abnormal' : 'normal');
      statusEl.textContent = abnormal ? t("status_abnormal") : t("status_normal");
      card.appendChild(statusEl);

      // 點擊顯示明細
      card.onclick = () => {
        modalTitle.textContent = `${dateStr} ${t("modal_detail_title")}`;
        modalBody.textContent = record.items.map(i=>{
          let status = i.source;
          if(i.source === "補打卡") status += i.approved ? `(${t("repair_approved")})` : `(${t("repair_pending")})`;
          return `${i.type} - ${new Date(i.datetime).toLocaleString()} ${status}`;
        }).join("\n");
        modalBackdrop.style.display = 'flex';
      };
    } else {
      // 沒有紀錄，不顯示標籤或狀態
      card.onclick = () => {
        modalTitle.textContent = `${dateStr} ${t("modal_detail_title")}`;
        modalBody.textContent = t("no_record");
        modalBackdrop.style.display = 'flex';
      };
    }

    calendarEl.appendChild(card);
  }
}

document.getElementById('prevMonth').onclick = ()=>{
  currentDate.setMonth(currentDate.getMonth()-1);
  fetchAttendanceDetails(currentDate.getFullYear(), currentDate.getMonth()+1);
};
document.getElementById('nextMonth').onclick = ()=>{
  currentDate.setMonth(currentDate.getMonth()+1);
  fetchAttendanceDetails(currentDate.getFullYear(), currentDate.getMonth()+1);
};
document.getElementById('homePage').onclick = ()=>{
  window.location.href = "index.html";
};
document.getElementById('closeModal').onclick = ()=>{ modalBackdrop.style.display='none'; };

// 初始載入
fetchAttendanceDetails(currentDate.getFullYear(), currentDate.getMonth()+1);

// JSONP callApi
function callApi(action, cb){
  const token = localStorage.getItem('sessionToken');
  const url = `https://script.google.com/macros/s/AKfycby28KblKy-ICEGstB7L-UK5rQ1awPokRiIIdqpJ49_7nVmS_oHYiA9qapWtOVo_UnEHbQ/exec?action=${action}&token=${token}&callback=handleResponse`;
  window.handleResponse = cb;
  const script = document.createElement('script');
  script.src = url;
  document.body.appendChild(script);
}
</script>
</body>
</html>
