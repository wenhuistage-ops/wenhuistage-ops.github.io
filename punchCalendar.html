<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>我的打卡月曆</title>
<style>
body {
  font-family: ui-sans-serif, system-ui;
  background:#f0f2f5;
  margin:0;
  display:flex;
  justify-content:center;
  padding:20px;
}
.container {
  max-width:520px;
  width:100%;
  background:#fff;
  border-radius:16px;
  padding:16px;
  box-shadow:0 4px 20px rgba(0,0,0,0.1);
}
header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
}
button {
  padding:8px 12px;
  border-radius:12px;
  border:0;
  cursor:pointer;
}
button.primary {
  background: linear-gradient(90deg,#4f46e5,#2563eb);
  color:#fff;
}
button.ghost {
  background:#eef2ff;
  color:#374151;
  border:1px solid #dbeafe;
}
.calendar {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
}
.day-card {
  background:#fff;
  border-radius:12px;
  padding:6px;
  min-height:70px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  display:flex;
  flex-direction:column;
  font-size:13px;
  position:relative;
}
.day-card.today { border: 2px solid #2563eb; }
.day-card .date { font-weight:600; margin-bottom:4px; }
.day-card .status {
  font-size:12px;
  padding:2px 6px;
  border-radius:6px;
  color:#fff;
  margin-top:auto;
}
.status.normal { background:#16a34a; }   /* 綠 */
.status.abnormal { background:#dc2626; } /* 紅 */
.tags {
  position:absolute;
  top:4px;
  right:4px;
  display:flex;
  gap:2px;
  flex-wrap:wrap;
}
.tag {
  font-size:10px;
  padding:1px 4px;
  border-radius:4px;
  background:#e0e7ff;
  color:#1e3a8a;
}
.modal-backdrop {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.35);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal {
  background:#fff;
  padding:16px;
  border-radius:12px;
  min-width:280px;
  max-width:90%;
}
</style>
</head>
<body>
<div class="container">
  <header>
    <button id="prevMonth" class="ghost">上一月</button>
    <h2 id="monthLabel"></h2>
    <div style="display:flex; gap:8px;">
      <button id="homePage" class="primary">打卡頁</button>
      <button id="nextMonth" class="ghost">下一月</button>
    </div>
  </header>
  <div class="calendar" id="calendar"></div>
</div>

<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3 id="modalTitle">打卡明細</h3>
    <div id="modalBody" style="margin-top:8px; white-space:pre-line; font-size:14px;"></div>
    <div style="text-align:right;margin-top:12px">
      <button id="closeModal" class="ghost">關閉</button>
    </div>
  </div>
</div>

<script>
const calendarEl = document.getElementById('calendar');
const monthLabel = document.getElementById('monthLabel');
const modalBackdrop = document.getElementById('modalBackdrop');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');

let currentDate = new Date();
let myRecords = []; // 後端回傳 getAttendanceDetails 的資料

function fetchAttendanceDetails(year, month) {
  const userId = localStorage.getItem('sessionUserId');
  alert(userId||'使用者ＩＤ');
  const monthStr = `${year}-${String(month).padStart(2,'0')}`;
  const action = `getAttendanceDetails&month=${monthStr}&userId=${userId}`;
  callApi(action, res => {
    if(res.ok){
      myRecords = res.records;
      renderCalendar();
    } else {
      alert(res.msg+userId+"測試"||'讀取紀錄失敗');
    }
  });
}

function renderCalendar(){
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  monthLabel.textContent = `${year} 年 ${month+1} 月`;

  const lastDay = new Date(year, month+1, 0);
  const today = new Date();

  calendarEl.innerHTML = '';

  for(let d=1; d<=lastDay.getDate(); d++){
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const record = myRecords.find(r => r.date === dateStr);

    const card = document.createElement('div');
    card.className = 'day-card';
    if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
      card.classList.add("today");
    }

    const dateEl = document.createElement('div');
    dateEl.className = 'date';
    dateEl.textContent = d;
    card.appendChild(dateEl);

    // 狀態判斷
    let abnormal = false;
    let tags = [];
    if(record){
      const types = record.items.map(i=>i.type);
      const hasOn = types.includes("上班");
      const hasOff = types.includes("下班");

      if(!hasOn || !hasOff) abnormal = true;
      record.items.forEach(i=>{
        if(i.source === "虛擬卡") tags.push("虛");
        if(i.source === "補打卡" && !i.approved) {
          abnormal = true;
          tags.push("補(待審)");
        }
      });
    }

    const span = document.createElement('span');
    span.className = 'status ' + (abnormal ? 'abnormal' : 'normal');
    span.textContent = abnormal ? '異常' : '正常';
    card.appendChild(span);

    // 標籤
    if(tags.length>0){
      const tagsEl = document.createElement('div');
      tagsEl.className = 'tags';
      tags.forEach(t=>{
        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.textContent = t;
        tagsEl.appendChild(tag);
      });
      card.appendChild(tagsEl);
    }

    // 點擊顯示細節
    card.onclick = () => {
      modalTitle.textContent = `${dateStr} 打卡明細`;
      if(record){
        modalBody.textContent = record.items.map(i=>{
          let status = i.source;
          if(i.source === "補打卡") status += i.approved ? "(已審核)" : "(待審)";
          return `${i.type} - ${new Date(i.datetime).toLocaleString()} ${status}`;
        }).join("\n");
      } else {
        modalBody.textContent = "無紀錄";
      }
      modalBackdrop.style.display = 'flex';
    };

    calendarEl.appendChild(card);
  }
}

document.getElementById('prevMonth').onclick = ()=>{
  currentDate.setMonth(currentDate.getMonth()-1);
  fetchAttendanceDetails(currentDate.getFullYear(), currentDate.getMonth()+1);
};
document.getElementById('nextMonth').onclick = ()=>{
  currentDate.setMonth(currentDate.getMonth()+1);
  fetchAttendanceDetails(currentDate.getFullYear(), currentDate.getMonth()+1);
};
document.getElementById('homePage').onclick = ()=>{
  window.location.href = "index.html";
};
document.getElementById('closeModal').onclick = ()=>{ modalBackdrop.style.display='none'; };

// 初始載入
fetchAttendanceDetails(currentDate.getFullYear(), currentDate.getMonth()+1);

// JSONP callApi
function callApi(action, cb){
  const token = localStorage.getItem('sessionToken');
  const url = `https://script.google.com/macros/s/AKfycby28KblKy-ICEGstB7L-UK5rQ1awPokRiIIdqpJ49_7nVmS_oHYiA9qapWtOVo_UnEHbQ/exec?action=${action}&token=${token}&callback=handleResponse`;
  window.handleResponse = cb;
  const script = document.createElement('script');
  script.src = url;
  document.body.appendChild(script);
}
</script>
</body>
</html>
